factor_engine:
  type: talib
  talib:
    adx_period: 14
    atr_period: 14
    macd_fast: 12
    macd_slow: 26
    macd_signal: 9
    volume_ratio_lookback: 72

# 自动降风险闭环（从“可观测”到“可执行”）
# - 推荐用法：先训练导出 model_info.json + feature_baseline.json，再在实盘/回测中启用
# - 本配置为“仓库默认值”，你可以用 .env 覆盖开关（例如 AUTO_RISK_ENABLED=true）
auto_risk:
  # 总开关（建议默认关闭：避免在未训练/未导出基线时引入行为变化）
  enabled: false

  # 证据落盘（用于复盘/重训决策，默认写入 artifacts/auto_risk/，gitignore 可重建）
  persist:
    enabled: true
    dir: "artifacts/auto_risk"

  # 1) 制度层（regime）：把市场状态归类为 bull_trend / bear_trend / range / crisis
  #    用途：按制度动态切换风险折扣（而不是一套静态阈值跑到底）
  regime:
    enabled: true
    # 若模型目录存在且 model_info.json 含 regime_evaluation，则优先复用训练侧的阈值（更一致）
    prefer_model_thresholds: true
    # 不同制度下的风险折扣（0~1，越小越保守）
    scale:
      bull_trend: 1.0
      bear_trend: 1.0
      # 方向与趋势相反时的折扣（例如 bull_trend 下做 short）
      against_trend: 0.70
      range: 0.85
      crisis: 0.30
      unknown: 0.85
    # 是否在 crisis 时直接禁止新开仓（默认仅降风险，不做硬停机）
    crisis_block_entries: false

  # 2) 概念漂移/数据质量：对比“最近窗口”特征分布 vs 训练基线
  #    输出：ok/warn/crit，并映射为“降仓/禁新开”等动作
  drift:
    enabled: true
    # 每隔多少根K线做一次检测（建议：与 timeframe 同步；例如 4h 策略=1 即每4小时）
    check_interval_candles: 1
    # 对比窗口大小（行数）
    window: 500
    # 额外预热行数（滚动特征需要更多历史，避免整窗 NaN）
    warmup: 200
    # 门控特征：仅这些特征参与“整体漂移判定”（其余特征更偏监控/解释）
    # 经验：skew/kurt/ema_spread 在加密市场上天然高波动，容易导致误触 crit。
    gate_features:
      # 注意：短周期收益（ret_1/ret_3）在加密市场上天然非平稳，容易导致“长期 warn/crit”。
      # 建议把它们留作“解释/监控”而不是“整体判定门控”，把制度变化交给 regime 处理。
      - ret_12
      - vol_12
      - volume_z_72
      - hl_range
    # 整体聚合策略：避免“单一噪声特征”导致长期 crit（从而频繁硬禁开仓）
    # - crit：crit_features >= max(crit_min_count, ceil(total * crit_min_ratio))
    # - warn：(warn+crit) >= max(warn_min_count, ceil(total * warn_min_ratio))
    aggregate:
      # 更稳健：只有“多项关键特征同时严重异常”才进入 crit，避免长期禁新开
      crit_min_count: 3
      crit_min_ratio: 0.05
      # 允许单一特征轻微异常时维持 ok（减少长期 warn）
      warn_min_count: 3
      warn_min_ratio: 0.05
    # warn/crit 的风险折扣（0~1）
    warn_scale: 0.80
    crit_scale: 0.30
    # crit 时是否禁止新开仓（推荐开启：先止血，再考虑重训/复盘）
    crit_block_entries: true
    # 从 crit 恢复到允许开仓所需的连续 ok 次数（避免状态抖动）
    recover_ok_checks: 3
    # 缺少基线/特征异常时是否“放行”（建议 true，避免因为模型缺失阻断交易）
    fail_open: true
    thresholds:
      # 加密市场天然非平稳：PSI 会显著大于传统风控场景（信用评分/用户画像）
      # 这里给更“宽”的默认阈值，避免长期处于 crit；建议用 scripts/analysis/auto_risk_replay.py 校准。
      # 校准记录（okx/BTC/4h, 2022-2024）：psi_warn=0.30 会导致长期 warn
      psi_warn: 0.45
      psi_crit: 1.00
      mean_z_warn: 3.0
      mean_z_crit: 6.0
      missing_warn: 0.05
      missing_crit: 0.20

  # 3) 市场代理/外溢风险：以 BTC 作为市场代理（CMKT proxy）
  #    监控 BTC↔pair 的相关性/β 断裂，第一版仅做“软缩放”（不新增禁新开）
  market_context:
    enabled: true
    # 市场代理交易对（默认 BTC/USDT）
    # - 若你的交易对是合约格式（例如 ETH/USDT:USDT），系统会自动把 market_pair 补成 BTC/USDT:USDT
    market_pair: "BTC/USDT"
    # “当前窗口”长度：用于估计 corr/beta 的短期值
    window: 72
    # “参考窗口”长度：用于估计 corr/beta 的历史基准（long）
    reference_window: 500
    # 最少有效样本数（不足则 fail-open）
    min_periods: 50
    # 最小缩放下限（scale ∈ [min_scale, 1]）
    min_scale: 0.80
    # 断裂判定：用“短期 vs 长期”的变化量（delta）做分段缩放（更抗误触）
    # - corr_delta = |corr_short - corr_long|
    # - beta_delta = |beta_short - beta_long|
    # 更敏感一档（约为上一版的 60%~70%），目标是：
    # - warn 触发率 ~1%~5%（提供“结构变化”的轻量提醒）
    # - crit <1%（只在明显断裂时给到 min_scale）
    # 校准记录（okx/4h, 2022-2024, ETH）：上一档（0.18/0.35/0.35/0.70）warn≈10.9%，偏高
    # 这一档放宽一点，目标 warn≈1%~5%，mean_scale≈0.99~1.00
    corr_delta_warn: 0.22
    corr_delta_crit: 0.44
    beta_delta_warn: 0.45
    beta_delta_crit: 0.90
