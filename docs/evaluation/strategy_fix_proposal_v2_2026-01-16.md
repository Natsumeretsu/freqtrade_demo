# SmallAccountFuturesTimingExecV1 策略修复方案 V2

更新日期：2026-01-16


## 执行摘要

**当前状态（方案 A 实施后）**：
- 胜率：67.20%
- 盈亏比：0.514（目标 ≥ 1.5）
- 总收益：-3.92%（仍亏损）
- 黑天鹅事件：62 笔（所有亏损交易）
- 平均盈利：4.218%
- 平均亏损：8.199%

**核心问题**：
1. 止损 -8% 相对于平均盈利 4.218% 过大（盈亏比 0.514）
2. 追踪止损激活点 5% 高于平均盈利，导致大部分交易无法激活
3. 62 笔亏损全部触及 -8% 止损线，无提前退出

**修复目标**：
- 盈亏比：从 0.514 提升至 ≥ 1.5
- 总收益：从 -3.92% 提升至 > 0%
- 黑天鹅事件：从 62 笔降至 < 30 笔
- 平均亏损：从 -8.199% 降至 < -5%

---

## 问题诊断

### 1. 退出原因分布分析

```
roi: 102 笔 (54.0%)              # ROI 止盈退出
stop_loss: 62 笔 (32.8%)         # 固定止损退出（全部触及 -8%）
trailing_stop_loss: 24 笔 (12.7%) # 追踪止损退出
force_exit: 1 笔 (0.5%)          # 强制退出
```

**关键发现**：
- 54% 的交易通过 ROI 止盈，说明 ROI 阶梯有效
- 32.8% 的交易触发固定止损，全部触及 -8% 止损线
- 仅 12.7% 的交易触发追踪止损（激活点过高）

### 2. 止损设置问题

**当前设置**：
```python
stoploss = -0.08  # -8% 固定止损
```

**问题**：
- 所有 62 笔亏损交易都触及 -8% 止损线（-8.22% ~ -8.29%）
- 平均亏损 -8.199%，接近止损线
- 说明止损被完全触发，无提前退出机制

**影响**：
- 每次止损需要 1.94 次平均盈利（8.199% / 4.218%）才能弥补
- 当前胜率 67.2%，但盈亏比 0.514 导致整体亏损

### 3. 追踪止损配置问题

**当前设置**：
```python
trailing_stop = True
trailing_stop_positive_offset = 0.05  # 盈利 5% 激活
trailing_stop_positive = 0.02         # 追踪距离 2%
trailing_only_offset_is_reached = True
```

**问题**：
- 激活点 5% 高于平均盈利 4.218%
- 导致大部分盈利交易（54% ROI 退出）无法激活追踪止损
- 只有 24 笔（12.7%）触发追踪止损

**影响**：
- 无法保护已有盈利
- 盈利交易容易回撤后变成亏损或小盈利

---

## 修复方案

### 方案 B：激进收紧止损（推荐）

**目标**：盈亏比 1.5，平均亏损 < -5%

**参数调整**：
```python
# 1. 收紧止损至 -5%
stoploss = -0.05

# 2. 保持 ROI 阶梯不变（已验证有效）
minimal_roi = {
    "0": 0.12,    # 12% 立即止盈
    "30": 0.10,   # 30 分钟后 10%
    "60": 0.08,   # 1 小时后 8%
    "120": 0.06,  # 2 小时后 6%
    "240": 0.04   # 4 小时后 4%
}

# 3. 降低追踪止损激活点
trailing_stop = True
trailing_stop_positive_offset = 0.03  # 从 5% 降至 3%（低于平均盈利）
trailing_stop_positive = 0.015        # 从 2% 降至 1.5%
trailing_only_offset_is_reached = True
```

**预期效果**：
- 止损从 -8% 降至 -5%（减少 37.5% 单笔亏损）
- 平均盈利保持 4-5%（ROI 阶梯不变）
- 盈亏比：4.5% / 5% = 0.9（接近 1.0）
- 追踪止损激活率提升（3% < 4.218% 平均盈利）

**风险评估**：
- 胜率可能从 67% 降至 50-60%（更严格的止损）
- 但盈亏比改善可能弥补胜率下降
- 需要验证因子信号在 -5% 止损下的有效性

---

### 方案 C：平衡方案（备选）

**目标**：盈亏比 1.2，平衡风险与收益

**参数调整**：
```python
# 1. 收紧止损至 -6%
stoploss = -0.06

# 2. 微调 ROI 阶梯（提高低端 ROI）
minimal_roi = {
    "0": 0.12,    # 12% 立即止盈
    "30": 0.10,   # 30 分钟后 10%
    "60": 0.08,   # 1 小时后 8%
    "120": 0.07,  # 2 小时后 7%（从 6% 提高）
    "240": 0.05   # 4 小时后 5%（从 4% 提高）
}

# 3. 调整追踪止损
trailing_stop = True
trailing_stop_positive_offset = 0.04  # 盈利 4% 激活
trailing_stop_positive = 0.018        # 追踪距离 1.8%
trailing_only_offset_is_reached = True
```

**预期效果**：
- 止损从 -8% 降至 -6%（减少 25% 单笔亏损）
- 平均盈利提升至 5-6%（提高低端 ROI）
- 盈亏比：5.5% / 6% = 0.92
- 追踪止损激活率适中

---

## 实施步骤

### 第一步：备份当前策略

```powershell
Copy-Item "01_freqtrade/strategies/SmallAccountFuturesTimingExecV1.py" `
          "01_freqtrade/strategies/SmallAccountFuturesTimingExecV1_backup_方案A_$(Get-Date -Format 'yyyyMMdd_HHmmss').py"
```

### 第二步：应用修复方案

**推荐顺序**：方案 B → 方案 C

1. **先测试方案 B（激进）**：验证 -5% 止损是否可行
2. **再测试方案 C（平衡）**：如果方案 B 胜率过低

**修改位置**：[01_freqtrade/strategies/SmallAccountFuturesTimingExecV1.py:66-78](../../01_freqtrade/strategies/SmallAccountFuturesTimingExecV1.py#L66-L78)

### 第三步：运行回测

```powershell
./scripts/ft.ps1 backtesting `
    --strategy SmallAccountFuturesTimingExecV1 `
    --config 04_shared/configs/small_account/config_small_futures_timing_15m_koop_v1.json `
    --timerange 20250101-20260116
```

### 第四步：运行快速诊断

```powershell
uv run python -X utf8 scripts/evaluation/quick_diagnosis.py `
    --zip "01_freqrade/backtest_results/backtest-result-<timestamp>.zip"
```

### 第五步：对比验证

**关键指标对比表**：

| 指标 | 方案 A（当前） | 方案 B 目标 | 方案 C 目标 |
|------|---------------|-------------|-------------|
| 胜率 | 67.20% | 50-60% | 55-65% |
| 盈亏比 | 0.514 | ≥ 0.9 | ≥ 0.92 |
| 平均盈利 | 4.218% | 4-5% | 5-6% |
| 平均亏损 | 8.199% | ≤ 5% | ≤ 6% |
| 总收益 | -3.92% | > 0% | > 0% |
| 黑天鹅事件 | 62 笔 | < 30 笔 | < 40 笔 |
| 最大单笔亏损 | -8.29% | ≤ -5% | ≤ -6% |

**验收标准**：

✅ **必须满足**（P0）：
- 盈亏比 ≥ 0.9
- 总收益 > 0%
- 黑天鹅事件 < 40 笔
- 最大单笔亏损 ≤ -6%

✅ **期望满足**（P1）：
- 盈亏比 ≥ 1.0
- 总收益 > 2%
- 胜率 ≥ 50%
- 黑天鹅事件 < 30 笔

✅ **理想满足**（P2）：
- 盈亏比 ≥ 1.5
- 总收益 > 5%
- Sharpe ≥ 1.0
- 最大回撤 < 20%

---

## 注意事项

### 1. 止损收紧的副作用

**胜率下降是正常的**：
- 从 67% 降至 50-60% 是预期内的
- 更严格的止损会增加止损次数
- 关键是盈亏比的改善能否弥补胜率下降

**计算示例**：
- 方案 A：67% × 4.218% - 33% × 8.199% = 0.12%（接近盈亏平衡，但实际 -3.92%）
- 方案 B：55% × 4.5% - 45% × 5% = 0.225%（理论盈利）

### 2. 追踪止损激活率

**降低激活点的好处**：
- 更多盈利交易可以激活追踪止损
- 保护已有盈利，避免回撤变亏损

**风险**：
- 追踪距离过小可能被正常波动触发
- 需要平衡激活率和追踪距离

### 3. 因子信号质量要求

**止损收紧后的挑战**：
- 因子信号需要更高的准确性
- 需要检查因子在 -5% 止损下的 IC 值
- 可能需要调整因子权重或阈值

---

## 总结与建议

### 核心问题回顾

方案 A 实施后的核心问题：
- 止损 -8% 相对于平均盈利 4.218% 过大
- 追踪止损激活点 5% 高于平均盈利，导致大部分交易无法激活
- 盈亏比 0.514 远低于目标 1.5

### 修复方案推荐

**首选方案**：方案 B（激进收紧止损）
- 止损：-5%
- 追踪止损激活点：3%
- 盈亏比目标：0.9-1.0

**备选方案**：方案 C（平衡方案）
- 止损：-6%
- 追踪止损激活点：4%
- 盈亏比目标：0.92

### 实施路线图

**第一阶段：快速验证**（1 天）
1. 应用方案 B 参数
2. 运行回测并诊断
3. 验证盈亏比是否改善

**第二阶段：优化调整**（1-2 天）
1. 如果方案 B 胜率过低，尝试方案 C
2. 微调追踪止损参数
3. 对比不同方案的结果

**第三阶段：深度验证**（2-3 天）
1. 不同市场环境测试
2. 参数稳定性测试
3. 动态滑点和资金费率评估

---

## 相关文档

- [快速诊断脚本](../../scripts/evaluation/quick_diagnosis.py)
- [方案 A 修复方案](strategy_fix_proposal_SmallAccountFuturesTimingExecV1_2026-01-16.md)
- [策略源码](../../01_freqtrade/strategies/SmallAccountFuturesTimingExecV1.py)

---

**文档版本**：v2.0
**创建日期**：2026-01-16
**最后更新**：2026-01-16
**作者**：Claude (Sonnet 4.5)
