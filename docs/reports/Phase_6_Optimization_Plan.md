# Phase 6 平衡优化计划

## 执行时间
2026-01-19

## 背景

### Phase 5 失败分析
- **交易频率**：71 → 465 笔 ✅（目标达成）
- **持仓时间**：75分钟 → 15分钟 ✅（目标达成）
- **总收益**：-5.79% → -38.08% ❌（严重恶化）
- **胜率**：33.1% → 38.5% ⚠️（略有提升但不足）
- **最大回撤**：38.53% ❌（非常危险）

### 失败原因
1. **止损过紧**：-0.4% 在 5 分钟级别导致频繁止损
2. **入场质量下降**：OFI 0.05 阈值太低，捕捉大量噪音信号
3. **标签设计过于激进**：20分钟预测窗口太短，标签不稳定

## Phase 6 优化目标

### 核心理念
在交易频率和质量之间找到平衡点，采用**渐进式优化**而非激进式改革。

### 目标指标
- **交易频率**：120-180 笔/90天（vs Phase 5 的 465 笔）
- **持仓时间**：30-45 分钟（vs Phase 5 的 15 分钟）
- **胜率**：> 45%（vs Phase 5 的 38.5%）
- **总收益**：50-100% 年化（vs Phase 5 的 -38%）
- **最大回撤**：< 20%（vs Phase 5 的 38.53%）

## 参数调整详情

### 1. 标签设计（已完成）

**文件**：`ft_userdir/strategies/ETHMicrostructureStrategy.py`

**修改位置**：`set_freqai_targets()` 方法

```python
# Phase 6 调整
forward_window = 6  # 30 分钟（从 Phase 5 的 4/20分钟 调整）
threshold = 0.005   # 0.5%（从 Phase 5 的 0.4% 调整）
```

**理由**：
- 30分钟预测窗口比20分钟更稳定，比60分钟更适合中短期交易
- 0.5%阈值平衡了交易机会和质量

### 2. ROI 和 Stoploss（已完成）

**文件**：`ft_userdir/strategies/ETHMicrostructureStrategy.py`

**修改位置**：类属性

```python
# Phase 6 调整
minimal_roi = {
    "0": 0.012,   # 1.2% 立即止盈（从 0.8% 提高）
    "15": 0.008,  # 15分钟后降到 0.8%
    "30": 0.005,  # 30分钟后降到 0.5%
    "45": 0.003   # 45分钟后降到 0.3%（保本）
}
stoploss = -0.008  # -0.8% 止损（从 -0.4% 放宽）
```

**理由**：
- ROI 梯度更平缓，鼓励持仓 30-45 分钟
- 止损从 -0.4% 放宽到 -0.8%，避免频繁止损
- 时间间隔从 10/20/30 分钟调整为 15/30/45 分钟

### 3. 入场条件（已完成）

**文件**：`ft_userdir/strategies/ETHMicrostructureStrategy.py`

**修改位置**：`populate_entry_trend()` 方法

```python
# Phase 6 调整
# 做多条件
(dataframe['ofi_10'] > 0.08) &        # 从 0.05 提高到 0.08
(dataframe['ofi_10_prev'] > 0.08) &   # 恢复单根K线持续性确认
(dataframe['vpin'] < 0.7) &           # 保持 0.7

# 做空条件
(dataframe['ofi_10'] < -0.08) &       # 从 -0.05 提高到 -0.08
(dataframe['ofi_10_prev'] < -0.08) &  # 恢复单根K线持续性确认
(dataframe['vpin'] < 0.7) &           # 保持 0.7
```

**理由**：
- OFI 阈值从 0.05 提高到 0.08，过滤噪音信号
- 恢复单根K线持续性确认，减少假突破
- 保持 VPIN 0.7 的风险控制

### 4. 出场条件（已完成）

**文件**：`ft_userdir/strategies/ETHMicrostructureStrategy.py`

**修改位置**：`populate_exit_trend()` 方法

```python
# Phase 6 调整
# 平多条件
(dataframe['ofi_10'] < -0.2) |  # 从 -0.15 放宽到 -0.2

# 平空条件
(dataframe['ofi_10'] > 0.2) |   # 从 0.15 放宽到 0.2
```

**理由**：
- OFI 阈值从 ±0.15 放宽到 ±0.2，减少过早出场
- 配合 ROI 梯度和适中止损，实现平衡收益

## 参数对比表

| 参数 | Phase 3 | Phase 5 | Phase 6 | 变化说明 |
|------|---------|---------|---------|----------|
| **标签设计** |
| forward_window | 12 (60分钟) | 4 (20分钟) | 6 (30分钟) | 平衡稳定性和响应速度 |
| threshold | 0.8% | 0.4% | 0.5% | 平衡机会和质量 |
| **ROI** |
| 立即止盈 | 2% | 0.8% | 1.2% | 提高盈利目标 |
| 时间梯度 | 单一 | 10/20/30分钟 | 15/30/45分钟 | 鼓励更长持仓 |
| **Stoploss** |
| 止损 | -5% | -0.4% | -0.8% | 避免频繁止损 |
| **入场条件** |
| OFI 阈值（多） | 0.1 | 0.05 | 0.08 | 提高入场质量 |
| OFI 阈值（空） | -0.15 | -0.05 | -0.08 | 提高入场质量 |
| 持续性确认 | 2根K线 | 无 | 1根K线 | 减少假信号 |
| **出场条件** |
| OFI 阈值 | ±0.4 | ±0.15 | ±0.2 | 减少过早出场 |

## 执行步骤

### 步骤 1：参数调整（已完成）
- ✅ 标签设计：forward_window 和 threshold
- ✅ ROI 和 Stoploss
- ✅ 入场条件：OFI 阈值和持续性确认
- ✅ 出场条件：OFI 阈值

### 步骤 2：运行回测（待执行）

**命令**：
```bash
pwsh -File ./scripts/ft.ps1 backtesting \
  --userdir ./ft_userdir \
  --strategy ETHMicrostructureStrategy \
  --config ft_userdir/config_freqai.json \
  --freqaimodel LightGBMClassifier \
  --timerange 20240401-20240630 \
  --breakdown month
```

**预期结果**：
- 交易数：120-180 笔
- 持仓时间：30-45 分钟
- 胜率：> 45%
- 总收益：> 0%

### 步骤 3：结果分析（待执行）

**关键指标检查**：
1. 交易频率是否在目标范围（120-180 笔）
2. 持仓时间是否在目标范围（30-45 分钟）
3. 胜率是否 > 45%
4. 总收益是否 > 0%
5. 最大回撤是否 < 20%

**对比分析**：
- vs Phase 3：交易频率提升，持仓时间缩短
- vs Phase 5：质量提升，收益改善

### 步骤 4：迭代优化（待执行）

**如果结果不理想**：
- 交易数过少（< 120）：降低 OFI 阈值到 0.07
- 交易数过多（> 180）：提高 OFI 阈值到 0.09
- 胜率过低（< 45%）：进一步提高 OFI 阈值或恢复市场状态过滤
- 持仓时间过长（> 45分钟）：收紧 ROI 梯度
- 持仓时间过短（< 30分钟）：放宽 ROI 梯度

## FreqAI 配置（可选优化）

**文件**：`ft_userdir/config_freqai.json`

**当前配置**：
```json
{
  "train_period_days": 60,
  "backtest_period_days": 3,
  "label_period_candles": 12,
  "include_shifted_candles": 2,
  "include_timeframes": ["5m", "15m", "1h"]
}
```

**可选优化**（如果 Phase 6 效果不佳）：
```json
{
  "train_period_days": 30,           // 缩短训练周期
  "backtest_period_days": 2,         // 更频繁重训练
  "label_period_candles": 6,         // 匹配 forward_window
  "include_shifted_candles": 5,      // 增加历史特征
  "include_timeframes": ["5m"]       // 只用 5m
}
```

## 风险提示

1. **过度优化风险**：参数调整基于历史数据，可能存在过拟合
2. **市场环境变化**：2024年4-6月的市场特征可能不适用于其他时期
3. **执行风险**：回测假设完美执行，实盘可能面临滑点和延迟
4. **资金管理**：建议从小资金开始测试，逐步增加

## 成功标准

### 最低标准（必须达到）
- ✅ 总收益 > 0%
- ✅ 胜率 > 40%
- ✅ 最大回撤 < 25%

### 理想标准（期望达到）
- ✅ 总收益 > 50%
- ✅ 胜率 > 45%
- ✅ 最大回撤 < 20%
- ✅ 交易数 120-180 笔
- ✅ 持仓时间 30-45 分钟

### 优秀标准（超预期）
- ✅ 总收益 > 100%
- ✅ 胜率 > 50%
- ✅ 最大回撤 < 15%

## 下一步计划

1. **立即执行**：运行 Phase 6 回测
2. **结果分析**：对比 Phase 3/5/6 的表现
3. **迭代优化**：根据结果微调参数
4. **文档更新**：记录最终参数和结果
5. **实盘准备**：如果回测满意，准备小资金实盘测试

## 附录：Phase 5 教训总结

### 成功经验
- ✅ 标签设计优化方向正确（缩短预测窗口）
- ✅ 交易频率提升成功（71 → 465 笔）
- ✅ 持仓时间缩短成功（75 → 15 分钟）

### 失败教训
- ❌ 止损过紧（-0.4%）导致频繁止损
- ❌ 入场阈值过低（OFI 0.05）捕捉噪音
- ❌ 预测窗口过短（20分钟）标签不稳定
- ❌ 移除持续性确认导致假信号过多

### 核心启示
**渐进式优化 > 激进式改革**

不要一次性改动所有参数，应该：
1. 先优化标签设计（最关键）
2. 再调整入场条件（控制质量）
3. 最后微调出场条件（优化收益）
4. 每次改动后验证效果

---

**文档版本**：1.0
**创建日期**：2026-01-19
**最后更新**：2026-01-19
**作者**：Claude (AI Assistant)
**状态**：✅ 参数调整完成，待回测验证
