# 模型预测 100% no_trade 的根本原因分析

**生成时间**: 2026-01-19
**问题**: 模型预测 100% no_trade，交易笔数从预期的数百笔降至 93 笔

---

## 执行摘要

通过深入分析发现，模型预测 100% no_trade 的根本原因不是类别不平衡（已设置 `is_unbalance=true`），而是**特征和标签之间几乎没有相关性**。

核心问题：**时间尺度不匹配** + **特征质量低下**
- 特征：基于瞬时微观结构（OFI、VPIN），反映当前时刻的订单流状态
- 标签：基于未来 30 分钟的价格变化
- 结果：瞬时特征无法预测 30 分钟后的结果

---

## 数据验证结果

### 1. 类别不平衡已处理
```json
{
  "is_unbalance": true,  // 已设置
  "label_distribution": {
    "no_trade": "89.24%",
    "trade": "10.76%"
  }
}
```
**结论**: 类别不平衡不是问题根源。

### 2. 特征在两个类别中的分布

| 特征 | trade 均值 | no_trade 均值 | 差异 | 标准差 | 区分度 |
|------|-----------|--------------|------|--------|--------|
| OFI_10 | -0.087446 | -0.013327 | 0.074 | 0.6 | **极差** |
| VPIN | 0.618228 | 0.618572 | 0.0003 | 0.09 | **无** |
| buy_pressure | 3381.67 | 1429.25 | 1952.41 | 11577 | 差 |
| sell_pressure | 4857.16 | 1563.37 | 3293.79 | 17840 | 差 |

**关键发现**:
- OFI_10 差异仅 0.074，相对于标准差 0.6 可以忽略不计
- VPIN 差异仅 0.0003，两个类别几乎完全相同
- 买卖压力虽然有差异，但在两个类别中为 0 的比例都是 77% 左右

### 3. 买卖压力为 0 的比例

| 类别 | buy_pressure=0 | sell_pressure=0 |
|------|----------------|-----------------|
| trade | 77.28% | 74.37% |
| no_trade | 76.73% | 76.36% |

**结论**: 买卖压力在两个类别中的分布几乎相同，无法区分。

### 4. OFI 阈值在两个类别中的表现

| OFI_10 范围 | trade | no_trade | 差异 |
|------------|-------|----------|------|
| > 0.08 | 41.46% | 45.30% | -3.84% |
| < -0.08 | 51.11% | 46.24% | +4.87% |
| [-0.08, 0.08] | 7.43% | 8.46% | -1.03% |

**结论**: OFI 阈值对两个类别的区分度极差，差异仅 3-5%。

### 5. VPIN 阈值在两个类别中的表现

| VPIN 范围 | trade | no_trade | 差异 |
|----------|-------|----------|------|
| < 0.7 | 82.41% | 83.17% | -0.76% |
| >= 0.7 | 17.59% | 16.83% | +0.76% |

**结论**: VPIN 阈值几乎没有区分度，差异不到 1%。

---

## 根本原因分析

### 原因 1: 时间尺度不匹配

**特征的时间尺度**:
- OFI: 5/10/20 根 K 线（25/50/100 分钟）的订单流不平衡
- VPIN: 20 根 K 线（100 分钟）的成交量毒性
- 买卖压力: 单根 K 线（5 分钟）的瞬时状态

**标签的时间尺度**:
- forward_window = 6 根 K 线（30 分钟）
- 预测未来 30 分钟内是否有 >0.5% 的收益机会

**问题**:
- 微观结构特征反映的是**瞬时或短期**的订单流状态
- 标签反映的是**30 分钟后**的价格变化
- 瞬时订单流信息在 30 分钟后已经衰减，无法预测长期价格

**类比**:
- 就像用"当前 1 秒的风速"预测"30 分钟后是否下雨"
- 时间尺度不匹配导致特征和标签之间没有因果关系

### 原因 2: 特征质量低下

**买卖压力计算问题**:
- 当前逻辑: `(price_change > 0) AND (volume_change > 0)` 才算买压
- 结果: 52.93% 的时间买卖压力都为 0
- 影响: OFI、VPIN、Microprice 等所有依赖特征都失效

**特征有效性验证**:
- 在 trade 和 no_trade 中，买卖压力为 0 的比例都是 77%
- 说明即使有买卖压力数据，也无法区分两个类别

### 原因 3: 特征和标签的因果关系缺失

**假设的因果链**:
```
当前订单流不平衡 (OFI)
  ↓
短期价格压力
  ↓
未来 30 分钟价格变化 (标签)
```

**实际情况**:
- 订单流不平衡的影响在几分钟内就会消失
- 30 分钟后的价格变化受到更多因素影响（新闻、宏观事件、大单等）
- 当前时刻的微观结构特征无法捕捉这些未来因素

---

## 为什么 is_unbalance=true 没有效果？

`is_unbalance=true` 的作用是**调整类别权重**，让模型更关注少数类（trade）。

但是：
1. **如果特征和标签没有相关性，调整权重也无济于事**
2. 模型学不到任何有用的模式，最优策略就是预测多数类
3. 即使强制预测 trade，准确率也不会提高（因为特征无法区分）

**类比**:
- 就像用"身高"预测"是否喜欢吃辣"
- 即使调整类别权重，身高和口味之间也没有因果关系
- 模型最优策略就是预测多数类（不喜欢吃辣）

---

## 解决方案

### 方案 A: 修改特征（推荐）

**目标**: 使用能够预测 30 分钟后价格的特征

**具体措施**:
1. **增加趋势特征**:
   - 价格动量（5/10/20/30 分钟）
   - 移动平均线交叉
   - RSI、MACD 等技术指标

2. **增加波动率特征**:
   - 已实现波动率（20/50/100 根 K 线）
   - ATR（Average True Range）
   - 布林带宽度

3. **增加成交量特征**:
   - 成交量相对强度
   - 成交量加权平均价（VWAP）偏离
   - 成交量趋势

4. **保留微观结构特征但降低权重**:
   - 修复买卖压力计算（使用 Money Flow 方法）
   - 作为辅助特征而非主要特征

**优势**:
- 不改变标签设计
- 特征和标签的时间尺度匹配
- 可以利用现有的回测框架

### 方案 B: 修改标签

**目标**: 使用微观结构特征能够预测的短期标签

**具体措施**:
1. **缩短预测窗口**:
   - forward_window 从 6 根（30 分钟）改为 1-2 根（5-10 分钟）
   - 预测短期价格变化

2. **调整阈值**:
   - threshold 从 0.5% 降低到 0.1-0.2%
   - 匹配短期价格波动

**优势**:
- 微观结构特征可以预测短期价格
- 特征和标签的因果关系更强

**劣势**:
- 需要更高频的交易
- 交易成本占比更大
- 可能不适合当前的交易策略

### 方案 C: 混合方案（最推荐）

**目标**: 结合方案 A 和 B 的优势

**具体措施**:
1. **修复买卖压力计算**（使用 Money Flow 方法）
2. **增加趋势和波动率特征**
3. **缩短预测窗口到 2-3 根 K 线（10-15 分钟）**
4. **调整阈值到 0.3%**

**优势**:
- 特征质量提升
- 时间尺度匹配
- 平衡交易频率和成本

---

## 实施优先级

### P0（立即执行）
1. **验证方案 C 的可行性**
   - 创建脚本分析不同 forward_window 和 threshold 下的标签分布
   - 分析特征和标签的相关性

2. **修复买卖压力计算**
   - 使用 Money Flow 方法
   - 验证数据覆盖率提升

### P1（高优先级）
3. **增加趋势和波动率特征**
   - 实现并验证新特征
   - 分析新特征和标签的相关性

4. **调整标签设计**
   - 测试不同的 forward_window（1, 2, 3, 6）
   - 测试不同的 threshold（0.1%, 0.2%, 0.3%, 0.5%）
   - 选择最优组合

### P2（中优先级）
5. **重新训练模型**
   - 使用修复后的特征和标签
   - 验证模型预测分布

6. **回测验证**
   - 对比修改前后的回测结果

---

## 下一步行动

1. **创建标签设计验证脚本**
   - 分析不同 forward_window 下的标签分布
   - 分析特征和标签的相关性
   - 找到最优的 forward_window 和 threshold

2. **实施 Money Flow 方法**
   - 修改策略代码
   - 验证数据覆盖率

3. **增加新特征**
   - 实现趋势和波动率特征
   - 验证新特征的有效性

4. **重新训练和回测**
   - 使用修复后的特征和标签
   - 验证改进效果

---

## 附录：关键数据

### 特征统计（trade vs no_trade）

```
OFI_10:
  trade:    均值=-0.087446, 标准差=0.630064
  no_trade: 均值=-0.013327, 标准差=0.582348
  差异: 0.074119 (相对于标准差 0.6，可以忽略不计)

VPIN:
  trade:    均值=0.618228, 标准差=0.091567
  no_trade: 均值=0.618572, 标准差=0.085444
  差异: 0.000344 (几乎完全相同)

buy_pressure:
  trade:    均值=3381.67, 标准差=11577.32, 为0比例=77.28%
  no_trade: 均值=1429.25, 标准差=4627.20,  为0比例=76.73%

sell_pressure:
  trade:    均值=4857.16, 标准差=17839.60, 为0比例=74.37%
  no_trade: 均值=1563.37, 标准差=5267.31,  为0比例=76.36%
```

### OFI 阈值表现

```
OFI_10 > 0.08:
  trade:    1155 / 2786 = 41.46%
  no_trade: 10469 / 23110 = 45.30%
  差异: -3.84%

OFI_10 < -0.08:
  trade:    1424 / 2786 = 51.11%
  no_trade: 10686 / 23110 = 46.24%
  差异: +4.87%

OFI_10 在 [-0.08, 0.08]:
  trade:    207 / 2786 = 7.43%
  no_trade: 1955 / 23110 = 8.46%
  差异: -1.03%
```

### VPIN 阈值表现

```
VPIN < 0.7:
  trade:    2296 / 2786 = 82.41%
  no_trade: 19221 / 23110 = 83.17%
  差异: -0.76%

VPIN >= 0.7:
  trade:    490 / 2786 = 17.59%
  no_trade: 3889 / 23110 = 16.83%
  差异: +0.76%
```

---

**报告结束**
