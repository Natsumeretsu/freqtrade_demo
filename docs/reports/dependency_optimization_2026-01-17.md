# 依赖管理优化分析报告

## 当前依赖配置分析

### 1. 核心依赖

| 包名 | 当前版本约束 | 问题 | 建议 |
|------|------------|------|------|
| freqtrade | Git 锁定 (8e91fea) | 🔴 无法自动更新，构建慢 | 切换到 PyPI 版本 |
| numpy | >=2.0.0,<2.4.0 | ✅ 合理范围约束 | 保持 |
| scikit-learn | >=1.8.0 | 🟡 上限开放 | 添加上限 <1.10.0 |
| pyqlib | >=0.9.0 | 🟡 上限开放 | 添加上限 <0.11.0 |
| lightgbm | >=4.0.0 | 🟡 上限开放 | 添加上限 <5.0.0 |
| pyyaml | >=6.0 | 🟡 上限开放 | 添加上限 <7.0 |
| python-dotenv | >=1.0.0 | 🟡 上限开放 | 添加上限 <2.0.0 |
| mcp | >=1.18.0,<2.0.0 | ✅ 合理范围约束 | 保持 |
| pydmd | >=2025.8.1 | 🟡 上限开放 | 添加上限 <2026.0.0 |

### 2. Freqtrade Git 依赖问题

**当前配置**：
```toml
[tool.uv.sources]
freqtrade = { git = "https://github.com/freqtrade/freqtrade.git", rev = "8e91fea11f3cc0354b952a5b667628b18378c7fe" }
```

**问题**：
- 每次安装都需要克隆 Git 仓库（慢）
- 无法利用 PyPI 的二进制轮子（wheel）
- 锁定在特定 commit，无法自动获取安全更新
- 增加 CI/CD 构建时间

**解决方案**：
切换到 PyPI 版本，使用精确版本约束：
```toml
dependencies = [
    "freqtrade[freqai,hyperopt]>=2024.12,<2025.2",
]
```

### 3. 版本约束策略

**当前问题**：
- 大部分依赖使用 `>=` 开放上限
- 可能导致意外的破坏性更新
- 难以复现构建环境

**建议策略**：
- 使用 `>=X.Y,<X+1.0` 范围约束（允许小版本更新）
- 关键依赖使用精确版本（如 numpy）
- 定期审查和更新依赖

### 4. 优化后的配置

```toml
[project]
name = "freqtrade-demo"
version = "0.1.0"
requires-python = ">=3.11,<3.13"
dependencies = [
    "freqtrade[freqai,hyperopt]>=2024.12,<2025.2",
    "nbformat>=4.2.0,<6.0.0",
    "numpy>=2.0.0,<2.4.0",
    "scikit-learn>=1.8.0,<1.10.0",
    "pyqlib>=0.9.0,<0.11.0",
    "lightgbm>=4.0.0,<5.0.0",
    "pyyaml>=6.0,<7.0",
    "python-dotenv>=1.0.0,<2.0.0",
    "mcp>=1.18.0,<2.0.0",
    "pydmd>=2025.8.1,<2026.0.0",
]

[tool.uv]
link-mode = "copy"

# 移除 Git 源，使用 PyPI
# [tool.uv.sources]
# freqtrade = { git = "..." }  # 已删除
```

### 5. 预期收益

- ⚡ 安装速度提升 50-70%（无需 Git 克隆）
- 🔒 更好的版本控制和可复现性
- 🛡️ 减少意外破坏性更新风险
- 📦 利用 PyPI 的二进制轮子，加快安装

### 6. 实施步骤

1. 备份当前 pyproject.toml
2. 更新依赖版本约束
3. 移除 Git 源配置
4. 运行 `uv sync` 重新安装
5. 运行完整测试套件验证
6. 提交更改

### 7. 风险评估

| 风险 | 严重性 | 缓解措施 |
|------|--------|---------|
| Freqtrade PyPI 版本功能差异 | 🟡 中 | 对比 Git 版本和 PyPI 版本的差异 |
| 依赖冲突 | 🟢 低 | 使用 uv 的依赖解析器自动处理 |
| 测试失败 | 🟢 低 | 运行完整测试套件验证 |

---

**创建日期**：2026-01-17
**状态**：待审批
