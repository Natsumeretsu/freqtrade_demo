# EMA/MACD 形态体系与 Vegas 隧道：可程序化落地笔记（vbrain 回灌）

更新日期：2026-01-12

本文目标：

1. 将“传统主观交易中常见的 EMA 交叉形态 + MACD 经典形态 + 零轴/鞭打（Whipsaw）/体制切换”的知识，转成**可程序化的条件、可验证的工程结论**。
2. 明确哪些形态更适合“现货只做多”的趋势系统，哪些形态更像抄底/逆势（在 smallaccount 约束下通常应避免）。
3. 给出与本仓库当前策略（`SmallAccountTrendFilteredV1`）的直接结合点：哪些规则可以作为“低过拟合风险”的下一步改进候选。

适用上下文（本仓库当前约束）：

- 交易标的：BTC/USDT（OKX spot）
- 交易方向：只做多（long-only）
- 时间周期：4h
- 资金约束：dry_run_wallet=10、max_open_trades=1
- 成本假设：fee=0.0006

---

## 0) 术语与实现对照（与本仓库一致）

在本仓库策略中，MACD 使用 TA-Lib 标准参数：

- `DIF`（快线）= `macd` = `EMA(close,12) - EMA(close,26)`
- `DEA`（慢线）= `macdsignal` = `EMA(DIF,9)`
- `HIST`（柱体）= `macdhist` = `DIF - DEA`
- “零轴” = 0（多空分界线）

交叉事件（可用 `technical.qtpylib`）：

- 金叉：`crossed_above(DIF, DEA)`
- 死叉：`crossed_below(DIF, DEA)`

重要提醒：

- `HIST > 0` 等价于 `DIF > DEA`（多头动能占优），但不等价于“处于多头大趋势”（因为 `DIF/DEA` 仍可能都在零轴下）。
- “零轴上方的金叉”通常更可靠；“零轴下方的死叉”通常更可靠。这是把“动量方向”与“体制位置”分开看的关键。

---

## 1) EMA 交叉形态：海底捞月（Bottom Fishing Pattern）的工程解读

### 1.1 形态含义（主观语义）

“海底捞月（EMA版）”本质是**超跌反弹/底部试探**：

- 价格急跌后出现探底回升
- 短期均线止跌回升，价格围绕短均线震荡但不再有效跌破
- 中长期均线多为走平或缓慢下行（大趋势未转强）

### 1.2 可程序化定义（建议口径）

在量化系统里，这类形态需要被明确标注为“逆势/反转”而非“顺势/中继”。一个可操作的定义框架（示意）：

- 长期趋势未确认：`EMA_long` 斜率 ≤ 0（或 `close < EMA_long`）
- 短期止跌：`EMA_short` 斜率从负转正（或 `EMA_short` 由下行转走平再上行）
- 价格不再创新低：`low` 的 N 根最低点抬高 / 或 `close` 连续收在 `EMA_short` 上方

### 1.3 与 smallaccount（现货只做多）的关系

在 long-only spot 的 smallaccount 目标下，这类“底部抄底”常见问题是：

- 胜率与赔率都高度依赖“底部是否真底”，遇到 2021/2022 这类结构性下行时容易连续止损；
- 即便最终反转，底部阶段的时间成本与磨损成本（手续费/滑点/噪声止损）会显著拉低净收益；
- 对应到工程上，最安全的做法往往是：**让系统默认不做底部交易**，除非另起一套专门的“反转赛道”与独立风控。

因此，当前 `SmallAccountTrendFilteredV1` 采用“长期 EMA 必须有效上行”等过滤，本质上就是**主动放弃海底捞月型机会**，用“少犯错”换“稳定性”。

---

## 2) MACD 8 种经典形态：分类、可编程条件、以及对现货策略的启示

下面把 8 种形态按“所在位置（零轴上下）”与“交叉事件（是否发生死叉/二次金叉）”拆成可程序化描述。

说明：这些形态来自主观交易常用术语。量化落地时，不建议追求 100% 复刻形态外观，而应抓住其“信息增益点”（位置 + 动量变化 + 是否鞭打），并以回测验证。

### 2.1 底部反转类（多数发生在零轴下）

这类形态的共同点：`DIF/DEA` 常在 0 以下运行，属于“弱势/底部区域”的动量修复。对 long-only spot 来说，它们往往更像“抄底”而不是“趋势中继”，应谨慎使用（更适合小仓位试探或单独策略）。

#### (1) 天鹅展翅

主观描述：
- 零轴下金叉后回调贴近 DEA，但不死叉就再次上行，红柱再次拉长。

可程序化要点（示意）：
- `DIF < 0 and DEA < 0`
- 出现金叉：`crossed_above(DIF, DEA)`
- 之后若干根内：`DIF` 下行接近 `DEA`，但 `DIF` 始终不低于 `DEA`
- `HIST` 先缩短后重新增大

落地启示：
- 属于“弱势反转”，在 smallaccount 中更适合当作“风险很小的试探仓位”，而不是主仓位信号。

#### (2) 小鸭出水

主观描述：
- 零轴下先金叉，随后死叉，再次二次金叉（双底式动量确认）。

可程序化要点（示意）：
- `DIF < 0 and DEA < 0`
- `crossed_above(DIF, DEA)` → `crossed_below(DIF, DEA)` → 再次 `crossed_above(DIF, DEA)`
- 二次金叉出现时，`DIF` 的低点抬高（动量底抬升）

落地启示：
- 比“单次金叉”更可靠，但仍属于底部结构；若用于趋势系统，往往需要叠加更高周期趋势确认。

#### (3) 海底电缆

主观描述：
- 零轴下运行较长时间后金叉，随后两线长时间贴合，最后多头发散。

可程序化要点（示意）：
- `DIF/DEA < 0` 持续较长（例如 N≥30）
- `crossed_above(DIF, DEA)` 后，`abs(DIF-DEA)` 长时间很小（“粘合”）
- 随后 `DIF` 明显上拐并拉开与 `DEA` 的差距

落地启示：
- 本质是“底部吸筹/长底”，对 smallaccount 的问题是：等待成本高、假突破多、样本少，容易过拟合。

#### (4) 海底捞月（MACD版）

主观描述：
- 零轴下出现“二次金叉”（双底式确认）。

可程序化要点（示意）：
- `DIF/DEA < 0`
- 至少两次 `crossed_above(DIF, DEA)`，且第二次发生时 `DIF` 低点抬升

落地启示：
- 和“小鸭出水”同族，区别更多是叙事角度；工程上可以统一为“零轴下二次金叉”一类信号。

### 2.2 中途盘整/中继类（核心是“动量回撤后的再发散”）

这类形态对“趋势跟随”更有意义，但关键是要区分：发生在零轴上还是零轴下，以及是否发生死叉。

#### (5) 佛手向上

主观描述：
- 金叉后上行，回调时 `DIF` 回落到 `DEA` 附近立即拐头向上，均线多头排列。

可程序化要点（示意）：
- 已处于多头动量：`DIF > DEA`
- 回调过程中：`DIF` 下降，`HIST` 缩短，但不发生死叉（`DIF` 仍 ≥ `DEA`）
- 随后 `DIF` 重新上拐，`HIST` 扩张

落地启示：
- 这与“趋势中回撤再上”的交易直觉一致；对 long-only spot 主要价值在于：**提高 time-in-market 而不是抄底**。

#### (6) 漫步青云

主观描述：
- 零轴上死叉并下穿零轴，随后在零轴附近或以上再次金叉。

可程序化要点（示意）：
- 先出现一次零轴上死叉：`crossed_below(DIF, DEA) and DIF > 0`
- 之后 `DIF` 下穿 0（动量转弱）
- 后续再次金叉发生在 0 附近或 0 以上：`crossed_above(DIF, DEA) and DIF >= 0`

落地启示：
- 对趋势系统来说属于“弱转强”的过渡型；容易受参数影响，需要配合趋势过滤（例如 EMA 长期上行）以降低鞭打。

#### (7) 空中缆绳（MACD版）

关键特征（区别点）：
- `DIF` 回调到 `DEA` 附近 **但拒绝死叉**（不发生死叉）

可程序化要点（示意）：
- 零轴上：`DIF > 0 and DEA > 0`
- 回调阶段：`DIF` 接近 `DEA`，`HIST` 很小但保持 `>= 0`
- 随后再次发散：`HIST` 从很小重新扩大

落地启示：
- 典型的“强趋势中继”信号；用于 long-only spot，最适合绑定在“牛市不掉队”的加仓/再入逻辑上。

#### (8) 空中缆车（MACD版）

关键特征（区别点）：
- 发生明确死叉，但 `DIF` 不下穿零轴，随后在零轴上再次金叉

可程序化要点（示意）：
- 死叉发生在零轴上：`crossed_below(DIF, DEA) and DIF > 0 and DEA > 0`
- 随后若干根内：`DIF` 仍保持 `> 0`（“不下穿零轴”）
- 再次金叉仍发生在零轴上：`crossed_above(DIF, DEA) and DIF > 0 and DEA > 0`

落地启示：
- 本质是“强趋势中的回撤整理”。如果系统把 `HIST > 0` 作为硬门槛，往往会在这个阶段错过再入机会，从而牛市掉队。
- 但它同样可能在“假强势反弹”里出现，因此需要宏观过滤（更长 EMA / 更高周期）或更严格的风险预算。

---

## 3) 理论与工程启示：为什么“过滤 + 风控”比“识别更多形态”更重要

### 3.1 鞭打效应（Whipsaw）是 MA/MACD 的结构性代价

在震荡/横盘体制里，EMA 与 MACD 会反复交叉：

- 进出频繁 → 交易成本被放大（尤其是手续费与滑点）
- 信号“看似正确”但缺乏持续性 → 小亏叠加成大回撤

工程应对的优先级：

1. 先做体制过滤（趋势/震荡分区），再谈形态识别；
2. 先把“尾部风险（最大亏损/连续亏损）”收敛到可承受区间，再谈提高收益；
3. 先做可解释、少参数的规则，再谈精细化形态分类（避免过拟合）。

### 3.2 参数依赖性与过拟合风险（必须正视）

均线交叉/MACD 的有效性高度依赖：

- 标的（BTC/ETH/山寨币差异巨大）
- 周期（15m/1h/4h/1d 的最优参数不一致）
- 成本（fee/slippage 的边界会改变“可交易信号”的净收益）
- 市场体制（趋势/震荡/急跌/政策鞭打）

工程上应坚持：

- 优先做“跨年份稳定性”验证（例如按年窗口 2020-2025）。
- 所有参数变化必须伴随“回撤约束”与“交易数约束”，否则很容易把策略调成“只在少数窗口好看”。

---

## 4) Vegas 隧道（20/144/169/576/676）：框架、可落地部分、与本策略的映射

### 4.1 核心结构与意图

Vegas 隧道是多层 EMA 的趋势过滤框架：

- `EMA20`：短周期动量确认（过滤真假突破）
- `EMA144/EMA169`：中期“隧道”（动态支撑/阻力与中继区）
- `EMA576/EMA676`：宏观方向过滤（大方向与终极防线）

它强调的不是“预测”，而是：

- 顺势交易（宏观方向一致才出手）
- 减少鞭打（多层确认）
- 明确止损/退出边界（尤其强调“终极止损”）

### 4.2 与本仓库当前策略的直观对应

`SmallAccountTrendFilteredV1` 已具备部分 Vegas 思想的“工程等价物”：

- 我们的 `EMA_short`（默认 20）≈ `EMA20`
- 我们的 `EMA_long`（默认 160）≈ `EMA144/169`（同量级的“中期隧道”）
- 我们已经用 `ADX` 与 `ATR%` 做趋势/波动门控，属于“减少鞭打”的过滤层
- 我们通过 `enter_tag=bull/cross/reentry` 把“趋势启动 / 趋势中回撤再入 / 强势追随”拆开，这等价于把形态分类工程化

当前缺口主要在两点：

1. **缺少更长周期的“宏观方向过滤”**（Vegas 的 576/676 层）；  
2. **对零轴上“缆绳/缆车”类中继信号的再入策略尚未显式表达**（当前仍是 `HIST>0` 的硬门槛）。

---

## 5) 对 `SmallAccountTrendFilteredV1` 的可落地改进清单（按低过拟合优先级排序）

> 说明：这里仅给“候选方向”，不代表必须立即改代码；每一项都应按年度窗口回测验证。

### 5.1 方向A：零轴作为“风险预算门控”（低侵入、偏风控）

思路：不把零轴当成“进场硬门槛”，而把它当成“风险预算/仓位上限”的门控。

- `DIF>0 && DEA>0`：允许更高仓位/更积极再入（偏趋势中继）
- `DIF<0 && DEA<0`：降低仓位或禁用 `bull_mode`（避免弱势反弹阶段的尾部亏损）

好处：更像“风险管理”而不是“形态追逐”，过拟合风险相对更低。

### 5.2 方向B：把“空中缆绳/缆车”显式纳入 bull 再入（偏提升牛市 time-in-market）

思路：对 bull 再入允许更细的 MACD 状态：

- 缆绳：`HIST` 很小但保持为正（拒绝死叉）→ 允许再入
- 缆车：允许短暂 `HIST<0`（死叉）但 `DIF/DEA` 都仍 > 0 → 允许再入

关键风险：这会提升暴露时间，若宏观方向不够强，可能在“假强势反弹”里增加亏损。  
因此建议与“宏观过滤/弱势降仓/止损收敛”组合使用，而不是单独上。

### 5.3 方向C：引入 Vegas 宏观过滤（减少 2021/2022 类年份的试错次数）

思路：在 4h 内计算更长 EMA（例如 576/676）作为“参与资格”：

- 只在 `EMA576 > EMA676` 且 `close > EMA576` 时允许 `bull_mode` 或提高仓位
- 或将其作为“弱势判定”的补充条件，强化去现金

代价：

- 需要提高 `startup_candle_count`（避免长 EMA 冷启动的失真）
- 可能降低交易次数（需确保仍满足 smallaccount 的最小交易数门槛）

---

## 6) 给你搜集/补充资料的关键词清单（面向后续迭代）

你可以按“解决问题 → 找资料”的方式搜集（比泛泛读形态更高效）：

- 解决“牛市不掉队但不增加尾部风险”：
  - `MACD cable / cable car pattern`
  - `MACD above zero whipsaw`
  - `trend continuation pullback entry`
- 解决“熊市活下来/减少 -10% 尾部止损”：
  - `Chandelier Exit`
  - `Volatility stop`
  - `intratrade drawdown stop`
  - `risk-off regime filter`
- 解决“减少鞭打”：
  - `ADX regime filter`
  - `Bollinger band filter for MA crossover`
  - `multi-timeframe confirmation`
- 解决“避免过拟合”：
  - `walk-forward validation`
  - `purged k-fold`
  - `parameter robustness`

