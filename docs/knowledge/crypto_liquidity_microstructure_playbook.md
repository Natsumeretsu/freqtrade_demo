# 加密货币流动性微观结构：工程化框架与落地边界（vbrain 回灌）

更新日期：2026-01-15

本文目标：

1. 将“主观支撑/阻力”升级为“流动性簇集（liquidity clustering）”的**可量化框架**，避免静态支阻思维。
2. 把 LOB（限价订单簿）、订单流（Order Flow / OFI）、价格冲击（Price Impact）转成**可实现的指标与流程**。
3. 明确哪些部分适合用于本仓库当前的 4h long-only 策略，哪些需要额外数据管道（否则无法回测验证，过拟合风险极高）。

适用上下文（本仓库当前约束）：

- 交易标的：BTC/USDT（OKX spot）
- 交易方向：只做多（long-only）
- 时间周期：4h（信号层）
- 资金约束：dry_run_wallet=10、max_open_trades=1（smallaccount）
- 成本假设：fee=0.0006（手续费），滑点取决于流动性制度

相关来源登记（用户提供，待抓取）：见 `docs/knowledge/source_registry.md` 的 S-945~S-971。

---

## 0) 一句话结论：支撑/阻力不是“历史位置”，而是“此刻流动性簇集”

传统支阻有效的核心原因并非“画线正确”，而是该价位附近存在订单聚集与行为一致性：

- 深盘口时，同一位置的“韧性”更强；
- 薄盘口/混乱时，同一位置可能被一次冲击直接穿越；
- 因此支阻必须随“盘口深度、点差、订单流方向”动态调整。

工程含义：

- **支阻=门控变量**（是否允许交易 / 是否降仓），而非“必反弹/必突破”的预测变量。

---

## 0.5) 心智模型：从价格曲线到“时间-价格密度场” ρ(t,p)

如果你用“流体二维平面”来直觉化价格，需要做一个关键校正：

- (t, P(t)) 只是一条“价格随时间的轨迹线”（曲线），并不是二维流体面。
- 真正像流体的对象，通常是定义在 (t, p) 上的某种**密度场** ρ(t,p)，例如：
  - **成交密度**：在时刻 t、价位 p 附近的成交量/成交笔数（时间-价格热力图）。
  - **订单簿深度密度**：买/卖盘在价位 p 的挂单深度 ρ_bid/ρ_ask（LOB）。
  - **概率密度**：把价格视为随机过程时，ρ(t,p) 表示“时刻 t 价格落在 p 的概率密度”。

在这个视角里：

- 价格路径 P(t) 可以被看作 ρ(t,p) 中某条“特征线/中心线”（例如中位成交价、VWAP、或密度峰的轨迹）。
- 支撑/阻力更接近“高密度/高黏度区域”（流动性簇集），穿透后常见“断层式加速”（流动性空洞）。
- 极端波动更像“密度梯度陡峭/剪切增强”（薄盘 + 强订单流造成的激波/涡流）。

落地边界（对本仓库尤其重要）：

- **P0（OHLCV-only，可回测）**：拿不到真实 ρ_bid/ρ_ask，只能用弱代理做“制度分类/执行门控”的近似（例如 `atr_pct`、相对成交量、K 线实体/影线结构）。
- **P1（实盘/模拟盘，可拉取 orderbook）**：才有条件把 ρ_bid/ρ_ask 做成执行过滤器（点差/深度/imbalance → 制度A/B/C → 是否允许下单/是否降仓）。

---

## 0.6) 三条线统一成一个“流体视角”框架：SDE / PDE / 守恒

你可以把市场拆成三层，各自对应一类“流体类比”，并且在工程上天然是“上层控风险、下层控执行”的分工：

1) **价格 = 随机过程（SDE）**：时间轴上的“粒子轨迹”  
   - 你观测到的是 P(t) 或 log-return r(t) 的样本路径。  
   - 工程上更常用它来做：波动率/跳跃风险/制度切换（regime）识别，作为上层风险标签。  
   - 对本仓库：更建议把该层输出用作“仓位/杠杆/止损距离”的调参输入，而不是硬方向开关（参见 `docs/knowledge/crypto_price_forecasting_models_playbook.md` 与 `docs/knowledge/crypto_risk_factors_engineering_playbook.md`）。

2) **订单簿 = 连续介质（PDE/SPDE）**：价格-数量平面上的“流体密度”  
   - 对象是 ρ_bid(t,p)、ρ_ask(t,p) 这样的密度场，描述在价位 p 的深度如何随时间演化。  
   - 工程上不必真的数值解 PDE：更现实的做法是提取“点差/深度/imbalance/斜率/空洞/恢复速度”等可观测指标，用于执行过滤与风控门控（本文第 1~5 节）。

3) **资金流 = 守恒方程**：不同“池子”之间的质量守恒 + 压强差  
   - 把交易所余额、链上资金迁移、DeFi TVL/借贷/质押等看作多个水库，净流入/净流出决定“总水位”和风险偏好。  
   - 对本仓库：该层通常需要 P2 外部数据（链上/第三方/基金流），更适合用于“风险开关/风险预算上限”（而不是信号层频繁交易）。

三层闭环的一个实用理解是：

- **守恒层（慢变量）**决定“能不能加水位”（总体风险暴露/杠杆上限）。  
- **SDE 层（中变量）**决定“现在河道湍不湍急”（波动/跳跃/制度），据此调整止损、仓位分档与是否禁新开。  
- **订单簿层（快变量）**决定“这一刻能不能安全下单”（点差/深度/空洞），据此选择 maker/taker、下单规模与是否跳过。

范围声明（与本仓库主线一致）：

- 本仓库近期仍以**单交易对时间序列择时**为主线；PDE/守恒层更多用于“把直觉翻译成可执行的门控/风控口径”，而不是立刻上高频 L2/L3 深度学习系统。

---

## 1) 三大支柱的工程化定义

### 1.1 LOB（Limit Order Book，限价订单簿）

订单簿快照（示意）：

- `bids`: [(price, size), ...] 价格从高到低
- `asks`: [(price, size), ...] 价格从低到高

关键指标（建议统一用 mid 归一化，便于跨价位比较）：

- `mid = (best_bid + best_ask) / 2`
- `spread_bps = (best_ask - best_bid) / mid * 10000`
- `depth_bid_n = sum(size_i) for i in best N bids`
- `depth_ask_n = sum(size_i) for i in best N asks`
- `depth_ratio = depth_bid_n / max(depth_ask_n, eps)`（买压/卖压相对强弱）

常用衍生指标（可选，但要谨慎，避免过度参数化）：

- **订单簿不平衡（OBI/Book Imbalance）**：
  - `obi = (depth_bid_n - depth_ask_n) / max(depth_bid_n + depth_ask_n, eps)`，范围约 [-1, +1]
- **斜率（Slope）**：
  - 以“距离 best 价的 ticks”或“bps 距离”为横轴，深度为纵轴，对深度分布做简单拟合；斜率越陡 → 越薄盘。

工程提醒：

- LOB 是“被动挂单的库存”，会快速撤单与重挂；单次快照容易误判，需要滚动统计（均值/分位数）。
- 对 long-only 的 smallaccount 来说，LOB 更适合作为**执行与风控过滤**（能不能进/怎么下单），而不是信号层（进场方向）。

### 1.2 订单流不平衡（Order Flow Imbalance, OFI）

你提供的口径是“主动买 - 主动卖”归一化。工程上有两类 OFI：

1. **基于成交（trade-based）**：用 taker buy/sell volume（主动买/主动卖）计算。
2. **基于订单簿变化（book-based）**：用 best bid/ask 的增减变化计算（更贴近微观结构研究，但数据更难拿）。

实盘可实现的最小可用版本（trade-based）：

- `ofi = (taker_buy_vol - taker_sell_vol) / max(taker_buy_vol + taker_sell_vol, eps)`（窗口 30s~5m）

工程提醒：

- OFI 信号半衰期通常是“秒~分钟”，与 4h 信号层不匹配：它更像“入场执行过滤器/风险预算开关”，而非主信号。

### 1.3 价格冲击（Price Impact）：非线性与“容量”的根源

经验规律（多市场研究常见结论）：

- 小单成本近似“点差 + 临时冲击”
- 大单会触发“非线性冲击”（吃穿盘口、引发永久冲击）

对本仓库的工程含义：

- smallaccount（10USDT）阶段几乎不受冲击影响；
- 一旦资金做大，“容量”会由**盘口深度与冲击函数**决定，而非回测收益率决定。

---

## 2) 支撑/阻力的微观结构解释：支阻互换是“簇集身份转换”

你给出的 4 阶段过程可以直接工程化为“可观测条件”：

1. 支撑稳定：`depth_bid_n >> depth_ask_n`，`obi` 偏正，OFI 多为正/均值回复快。
2. 突破瞬间：OFI 快速转负且持续，盘口 bid 深度被消耗（或撤单），价差扩大。
3. 身份反转：原支撑位附近 ask 深度回补（形成卖单簇集），bid 深度无法恢复。
4. 互换确认：价格回测该位，出现“上方卖压 + OFI 转负”的组合，反弹失败。

工程落地点：

- 对 long-only：第 2/3/4 阶段应触发“风险预算下降/禁入/更激进止损”，而不是继续加仓摊低。

---

## 3) 三种“流动性制度”（Regime）与策略动作映射

这是最适合工程化落地的一层：把复杂微观结构压缩为“制度分类 → 动作表”。

### 3.1 制度A：深盘口 + 窄点差（良性流动性）

典型动作（更利于趋势追随）：

- 允许追单/突破后跟随（更容易是真突破）
- 可分批加仓（滑点更可控）
- 止损可以更“结构化”（围绕关键位），而非过窄

### 3.2 制度B：薄盘口 + 宽点差（脆弱流动性）

典型动作（更利于被动挂单/降低风险）：

- 禁止追单（突破更容易回拉）
- 倾向挂单等待更好价格（limit / maker 思路）
- 降仓，减少频率，避免盘整里被点差/滑点吃掉

### 3.3 制度C：混乱流动性（事件/黑天鹅）

典型动作（生存优先）：

- 降频（日线以上）或暂停
- 极小仓位（正常风险的 1/3 或更低）
- 优先控制“执行成本与尾部风险”，而不是追求方向正确

---

## 4) 信号半衰期 vs 交易周期：为什么“4h 策略不应直接吃 OFI”

你给出的“半衰期/有效期”视角非常关键：

- LOB/OFI 通常是秒~分钟级信号；
- 4h 的决策间隔远大于其半衰期；

再补一个容易被忽视但很致命的点：**K 线周期不是“市场周期”，而是采样间隔 Δt**。当你把秒/分钟级的微观结构信号硬塞进 4h 级别的决策，你不仅在“错配半衰期”，还会引入“混叠（aliasing）”——高频结构会被折叠成看似低频的伪规律，表现出来像“4h 上出现了某种周期/共振”，但本质上是采样选择造成的幻觉。

工程结论：

1. 4h 策略不应把 OFI 当成“方向信号”，否则很可能是在回测里拟合噪声；
2. 4h 策略可以把 OFI/LOB 当成“交易资格/执行条件”（例如：点差太大就不下单、薄盘就降仓）。

---

## 5) Freqtrade 视角的落地路径（分三档：可回测 / 实盘可用 / 需要外部数据）

### 5.1 档位1：只用 OHLCV（可回测、低过拟合优先）

限制：没有真实 LOB/OFI 数据，无法复刻微观结构指标。  
可行：用“代理变量”做制度分类（不是为了预测，而是为了风控）。

可用代理（示例）：

- 流动性代理：`rel_vol = volume / sma(volume, 30)`（成交量相对均值）
- 薄盘/混乱代理：`atr_pct = ATR / close`（波动率异常上升）
- 趋势代理：`ema_long` 方向与乖离（避免逆势抄底）

可落地动作（适合当前 smallaccount 策略）：

- `atr_pct` 极端升高时：降低仓位/更严格的入场门控；
- `rel_vol` 极低时：减少交易（避免被成本与噪声吞噬）。

### 5.2 档位2：实盘/模拟盘可用（下单前拉取 LOB 快照作为“执行过滤器”）

目标：不改变信号层，只在执行层减少“点差/薄盘/混乱”造成的劣成交。

最小实现思路：

1. 下单前获取 orderbook 快照（N 档深度）；
2. 计算 `spread_bps`、`depth_bid_n`、`depth_ask_n`、`obi`；
3. 将其映射到“制度A/B/C”；
4. 根据制度调整：
   - 是否允许本次入场
   - 挂单/吃单策略（maker vs taker）
   - 仓位风险预算（降档）

风险提醒：

- 这部分在回测中通常无法验证（除非你有历史 orderbook 数据），因此它属于“实盘工程优化”，要谨慎上线并观测。

### 5.3 档位3：需要外部数据管道（想在回测里验证 OFI/LOB 的统计边际）

如果你真的要把“OFI 极值预警、LOB 斜率、撤单率”等做成核心信号层：

- 必须有历史 L2 orderbook / trades 数据；
- 必须做“成本 + 延迟 + 数据丢失”鲁棒性验证；
- 否则极易出现：回测很好、实盘不一致（数据不可得/时延/选择偏差）。

---

## 6) “容量”如何评估（从 smallaccount 到可扩展）

容量不是“资金上限”，而是“在可接受冲击成本内的最大下单量”。

实盘可计算的最小版本（以买单为例）：

1. 取 ask 侧盘口，按价格从低到高累加 size，直到满足目标数量 Q；
2. 计算该成交路径的 VWAP；
3. `slippage_bps = (vwap / mid - 1) * 10000`；
4. 设定可接受上限（例如 5~20 bps），反推最大 Q。

工程提醒：

- 若策略未来扩容，“容量评估”应成为上线前的硬门槛之一；
- 对 BTC 主流现货而言，小资金阶段容量不是瓶颈，但在薄盘时段/小币种上容量会迅速成为瓶颈。

---

## 7) 与当前 `SmallAccountSpotTrendFilteredV1` 的结合点（低过拟合优先）

你提供的框架最适合帮助我们解决两类问题：

1. **牛市不掉队但不乱追单**：在薄盘/宽点差时减少劣成交（执行层优化）。
2. **熊市/混乱期活下来**：把“制度C”识别为 risk-off（仓位/频率下降），避免固定止损被反复打穿。

优先落地建议（由低到高）：

1. 回测可验证的“制度代理门控”（OHLCV + ATR% + 相对成交量）→ 先稳健；
2. 实盘执行过滤器（orderbook 快照）→ 再减少成本；
3. 只有在你准备好历史 L2 数据时，再考虑把 OFI 作为信号层。

