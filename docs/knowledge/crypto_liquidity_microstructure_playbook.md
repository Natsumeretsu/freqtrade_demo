# 加密货币流动性微观结构：工程化框架与落地边界（vbrain 回灌）

更新日期：2026-01-12

本文目标：

1. 将“主观支撑/阻力”升级为“流动性簇集（liquidity clustering）”的**可量化框架**，避免静态支阻思维。
2. 把 LOB（限价订单簿）、订单流（Order Flow / OFI）、价格冲击（Price Impact）转成**可实现的指标与流程**。
3. 明确哪些部分适合用于本仓库当前的 4h long-only 策略，哪些需要额外数据管道（否则无法回测验证，过拟合风险极高）。

适用上下文（本仓库当前约束）：

- 交易标的：BTC/USDT（OKX spot）
- 交易方向：只做多（long-only）
- 时间周期：4h（信号层）
- 资金约束：dry_run_wallet=10、max_open_trades=1（smallaccount）
- 成本假设：fee=0.0006（手续费），滑点取决于流动性制度

相关来源登记（用户提供，待抓取）：见 `docs/knowledge/source_registry.md` 的 S-945~S-971。

---

## 0) 一句话结论：支撑/阻力不是“历史位置”，而是“此刻流动性簇集”

传统支阻有效的核心原因并非“画线正确”，而是该价位附近存在订单聚集与行为一致性：

- 深盘口时，同一位置的“韧性”更强；
- 薄盘口/混乱时，同一位置可能被一次冲击直接穿越；
- 因此支阻必须随“盘口深度、点差、订单流方向”动态调整。

工程含义：

- **支阻=门控变量**（是否允许交易 / 是否降仓），而非“必反弹/必突破”的预测变量。

---

## 1) 三大支柱的工程化定义

### 1.1 LOB（Limit Order Book，限价订单簿）

订单簿快照（示意）：

- `bids`: [(price, size), ...] 价格从高到低
- `asks`: [(price, size), ...] 价格从低到高

关键指标（建议统一用 mid 归一化，便于跨价位比较）：

- `mid = (best_bid + best_ask) / 2`
- `spread_bps = (best_ask - best_bid) / mid * 10000`
- `depth_bid_n = sum(size_i) for i in best N bids`
- `depth_ask_n = sum(size_i) for i in best N asks`
- `depth_ratio = depth_bid_n / max(depth_ask_n, eps)`（买压/卖压相对强弱）

常用衍生指标（可选，但要谨慎，避免过度参数化）：

- **订单簿不平衡（OBI/Book Imbalance）**：
  - `obi = (depth_bid_n - depth_ask_n) / max(depth_bid_n + depth_ask_n, eps)`，范围约 [-1, +1]
- **斜率（Slope）**：
  - 以“距离 best 价的 ticks”或“bps 距离”为横轴，深度为纵轴，对深度分布做简单拟合；斜率越陡 → 越薄盘。

工程提醒：

- LOB 是“被动挂单的库存”，会快速撤单与重挂；单次快照容易误判，需要滚动统计（均值/分位数）。
- 对 long-only 的 smallaccount 来说，LOB 更适合作为**执行与风控过滤**（能不能进/怎么下单），而不是信号层（进场方向）。

### 1.2 订单流不平衡（Order Flow Imbalance, OFI）

你提供的口径是“主动买 - 主动卖”归一化。工程上有两类 OFI：

1. **基于成交（trade-based）**：用 taker buy/sell volume（主动买/主动卖）计算。
2. **基于订单簿变化（book-based）**：用 best bid/ask 的增减变化计算（更贴近微观结构研究，但数据更难拿）。

实盘可实现的最小可用版本（trade-based）：

- `ofi = (taker_buy_vol - taker_sell_vol) / max(taker_buy_vol + taker_sell_vol, eps)`（窗口 30s~5m）

工程提醒：

- OFI 信号半衰期通常是“秒~分钟”，与 4h 信号层不匹配：它更像“入场执行过滤器/风险预算开关”，而非主信号。

### 1.3 价格冲击（Price Impact）：非线性与“容量”的根源

经验规律（多市场研究常见结论）：

- 小单成本近似“点差 + 临时冲击”
- 大单会触发“非线性冲击”（吃穿盘口、引发永久冲击）

对本仓库的工程含义：

- smallaccount（10USDT）阶段几乎不受冲击影响；
- 一旦资金做大，“容量”会由**盘口深度与冲击函数**决定，而非回测收益率决定。

---

## 2) 支撑/阻力的微观结构解释：支阻互换是“簇集身份转换”

你给出的 4 阶段过程可以直接工程化为“可观测条件”：

1. 支撑稳定：`depth_bid_n >> depth_ask_n`，`obi` 偏正，OFI 多为正/均值回复快。
2. 突破瞬间：OFI 快速转负且持续，盘口 bid 深度被消耗（或撤单），价差扩大。
3. 身份反转：原支撑位附近 ask 深度回补（形成卖单簇集），bid 深度无法恢复。
4. 互换确认：价格回测该位，出现“上方卖压 + OFI 转负”的组合，反弹失败。

工程落地点：

- 对 long-only：第 2/3/4 阶段应触发“风险预算下降/禁入/更激进止损”，而不是继续加仓摊低。

---

## 3) 三种“流动性制度”（Regime）与策略动作映射

这是最适合工程化落地的一层：把复杂微观结构压缩为“制度分类 → 动作表”。

### 3.1 制度A：深盘口 + 窄点差（良性流动性）

典型动作（更利于趋势追随）：

- 允许追单/突破后跟随（更容易是真突破）
- 可分批加仓（滑点更可控）
- 止损可以更“结构化”（围绕关键位），而非过窄

### 3.2 制度B：薄盘口 + 宽点差（脆弱流动性）

典型动作（更利于被动挂单/降低风险）：

- 禁止追单（突破更容易回拉）
- 倾向挂单等待更好价格（limit / maker 思路）
- 降仓，减少频率，避免盘整里被点差/滑点吃掉

### 3.3 制度C：混乱流动性（事件/黑天鹅）

典型动作（生存优先）：

- 降频（日线以上）或暂停
- 极小仓位（正常风险的 1/3 或更低）
- 优先控制“执行成本与尾部风险”，而不是追求方向正确

---

## 4) 信号半衰期 vs 交易周期：为什么“4h 策略不应直接吃 OFI”

你给出的“半衰期/有效期”视角非常关键：

- LOB/OFI 通常是秒~分钟级信号；
- 4h 的决策间隔远大于其半衰期；

工程结论：

1. 4h 策略不应把 OFI 当成“方向信号”，否则很可能是在回测里拟合噪声；
2. 4h 策略可以把 OFI/LOB 当成“交易资格/执行条件”（例如：点差太大就不下单、薄盘就降仓）。

---

## 5) Freqtrade 视角的落地路径（分三档：可回测 / 实盘可用 / 需要外部数据）

### 5.1 档位1：只用 OHLCV（可回测、低过拟合优先）

限制：没有真实 LOB/OFI 数据，无法复刻微观结构指标。  
可行：用“代理变量”做制度分类（不是为了预测，而是为了风控）。

可用代理（示例）：

- 流动性代理：`rel_vol = volume / sma(volume, 30)`（成交量相对均值）
- 薄盘/混乱代理：`atr_pct = ATR / close`（波动率异常上升）
- 趋势代理：`ema_long` 方向与乖离（避免逆势抄底）

可落地动作（适合当前 smallaccount 策略）：

- `atr_pct` 极端升高时：降低仓位/更严格的入场门控；
- `rel_vol` 极低时：减少交易（避免被成本与噪声吞噬）。

### 5.2 档位2：实盘/模拟盘可用（下单前拉取 LOB 快照作为“执行过滤器”）

目标：不改变信号层，只在执行层减少“点差/薄盘/混乱”造成的劣成交。

最小实现思路：

1. 下单前获取 orderbook 快照（N 档深度）；
2. 计算 `spread_bps`、`depth_bid_n`、`depth_ask_n`、`obi`；
3. 将其映射到“制度A/B/C”；
4. 根据制度调整：
   - 是否允许本次入场
   - 挂单/吃单策略（maker vs taker）
   - 仓位风险预算（降档）

风险提醒：

- 这部分在回测中通常无法验证（除非你有历史 orderbook 数据），因此它属于“实盘工程优化”，要谨慎上线并观测。

### 5.3 档位3：需要外部数据管道（想在回测里验证 OFI/LOB 的统计边际）

如果你真的要把“OFI 极值预警、LOB 斜率、撤单率”等做成核心信号层：

- 必须有历史 L2 orderbook / trades 数据；
- 必须做“成本 + 延迟 + 数据丢失”鲁棒性验证；
- 否则极易出现：回测很好、实盘不一致（数据不可得/时延/选择偏差）。

---

## 6) “容量”如何评估（从 smallaccount 到可扩展）

容量不是“资金上限”，而是“在可接受冲击成本内的最大下单量”。

实盘可计算的最小版本（以买单为例）：

1. 取 ask 侧盘口，按价格从低到高累加 size，直到满足目标数量 Q；
2. 计算该成交路径的 VWAP；
3. `slippage_bps = (vwap / mid - 1) * 10000`；
4. 设定可接受上限（例如 5~20 bps），反推最大 Q。

工程提醒：

- 若策略未来扩容，“容量评估”应成为上线前的硬门槛之一；
- 对 BTC 主流现货而言，小资金阶段容量不是瓶颈，但在薄盘时段/小币种上容量会迅速成为瓶颈。

---

## 7) 与当前 `SmallAccountSpotTrendFilteredV1` 的结合点（低过拟合优先）

你提供的框架最适合帮助我们解决两类问题：

1. **牛市不掉队但不乱追单**：在薄盘/宽点差时减少劣成交（执行层优化）。
2. **熊市/混乱期活下来**：把“制度C”识别为 risk-off（仓位/频率下降），避免固定止损被反复打穿。

优先落地建议（由低到高）：

1. 回测可验证的“制度代理门控”（OHLCV + ATR% + 相对成交量）→ 先稳健；
2. 实盘执行过滤器（orderbook 快照）→ 再减少成本；
3. 只有在你准备好历史 L2 数据时，再考虑把 OFI 作为信号层。

