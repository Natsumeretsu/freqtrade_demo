# FreqAI 方法论主干（TB / Meta-Labeling / 门控 / 不平衡 / 性能）

更新日期：2026-01-10

本记忆沉淀“可复用的方法论结论”，用于指导策略代码与配置的长期迭代。

---

## 1) 目标工程（Target Engineering）

- **分类优先**：短周期金融时序回归（连续收益）通常更难稳定；优先把目标离散化为分类标签（0/1 或多分类）。
- **单一真相**：预测窗口统一使用 `freqai.feature_parameters.label_period_candles`，并让训练标签与出场的时间障碍严格对齐。
- **必须声明类名**：使用分类器时，在 `set_freqai_targets()` 设置 `self.freqai.class_names = [...]`，确保推理阶段概率列名稳定（类名即列名）。

---

## 2) Triple Barrier + Meta-Labeling 的“口径一致性”

- 核心原则：模型要学的是“在执行约束下能否赚钱”，而不是“固定 horizon 的收盘价涨跌”。
- 训练标签若忽略路径依赖（中途触发止损/强平风险），会造成“训练目标与实盘执行逻辑断层”。
- 推荐落地：
  - TB 标签在训练阶段就把止盈/止损/时间障碍写进去；
  - Meta-Labeling 把 ML 用作“信号过滤/门控”，而不是强行做纯方向预测。

---

## 3) 概率门控（阈值 + 优势差）

- 不把概率当作精确的“可校准胜率”，更把它当作排序信号。
- 多分类/双向 CTA 建议用“优势差”结构降低抖动：
  - 多：`long > enter_prob` 且 `long > short + prob_margin`
  - 空：`short > enter_prob` 且 `short > long + prob_margin`

---

## 4) 样本不平衡（代价敏感学习的落地口径）

- LightGBM 侧：`is_unbalance` 与 `scale_pos_weight` **二选一**（不要同时启用）。
- 风险提示：启用不平衡权重可能提升整体指标，但会让类别概率估计变差；因此策略层应使用 `prob_margin` / 多条件门控，避免概率抖动导致过度交易。

---

## 5) 性能与向量化（TB 标签生成的工程约束）

- “向量化 ≠ 一定更快”：未来窗口矩阵（N×L）会显著放大内存与临时对象，可能导致更慢。
- 推荐方向：事件驱动/半向量化/分块计算（只对“候选信号点”计算 TB），并用测量（profiling）而不是直觉决定实现。

---

## 6) 时间序列验证（防信息泄露）

- 原则：时间序列强自相关，传统随机切分容易产生信息泄露。
- 方向建议：采用清除与禁运（Purged-Embargo）等隔离逻辑（后续可补抓取开放来源并登记到 `docs/knowledge/source_registry.md`）。

---

## 7) 超参优化策略（Hyperopt 的边界）

- 优先优化：入场/出场阈值、门控条件、风控参数。
- 不优先/避免：在 `feature_engineering_*()` 与 `set_freqai_targets()` 内做超参搜索（与 FreqAI 的预测复用机制不匹配）。
