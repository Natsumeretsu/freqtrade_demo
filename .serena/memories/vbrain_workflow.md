# vbrain（vibe brain）闭环工作流（默认执行）

更新日期：2026-01-11

目标：把本仓库的“vibe coding 项目大脑”固化为**可重复、可进化、低摩擦**的流程，让你不需要每次都提醒“回灌/记忆/进化”。

vbrain 不是单一工具，而是一套“**核心闭环 + 可选外设**”的分层系统：

**核心闭环（vbrain core）**

- **检索层（外部全文）**：`local_rag`（索引与召回，不做结论）
- **知识层（权威结论）**：`docs/` + `.serena/memories/`（可维护、可复用）
- **记忆层（套路/决策/画像）**：`in_memoria`（跨会话、代码画像、任务上下文）
- **代码操作层（落地工具）**：`serena`（符号级检索/编辑，用于把结论落地到代码与文档）

**输入层（feed，不属于 vbrain core）**

- feed 由独立采集层提供（例如 `vharvest`），vbrain 只负责 ingest/feed→检索→提炼→回灌→记忆。

> 关键点：vbrain 的核心只关心“**材料是否能被检索 + 结论是否被回灌 + 套路是否被固化**”。采集属于独立能力，与 vbrain 解耦。

---

## 1) 默认触发规则（让你“不说也会做”）

在每个阶段任务**收尾**时，默认执行一次 vbrain 闭环：

1. 本轮任务是否产生了**新结论/新参数/新流程/新坑点**？
2. 是否新增或更新了外部材料输入（例如：新增来源登记/导入外部资料到 `local_rag`）？
3. 是否发生了“推翻旧结论 / 发现冲突 / 规则变更”？

若以上全为否：仅做最小收尾（例如 `git status`），**跳过回灌**，避免噪声堆积。

---

## 2) 闭环步骤（Retrieve → Distill → Backfill → Memory → Index）

### 2.1 Retrieve（检索对照：避免重复与自相矛盾）

默认先做对照检索，再写入：

- 用 `local_rag` 查外部证据（全文/片段），确认“依据来自哪里”。
- 用 `in_memoria` 查本仓库已有套路/坑点/路径（避免重复造轮子）。
- 用仓库文档（`project_docs` + `.serena/memories`）确认已有“权威结论”是否已覆盖。

### 2.2 Distill（提炼：把原文变成可执行资产）

提炼产物必须满足：

- **可执行**：参数、阈值、命令、边界条件、失败处理
- **可复用**：不绑定一次性上下文；给出适用/不适用条件
- **可回溯**：能指向证据来源（URL 或 `S-xxx`）
- **可冲突处理**：标注置信度与“何时失效”

推荐结构（最小集合）：

- 结论（1 句话）
- 适用边界（何时用/何时不用）
- 工程落地（涉及的文件/脚本/关键参数）
- 风险与反例（最容易踩坑的点）
- 证据（`S-xxx` 或 URL）
- 置信度（0~1）

### 2.3 Backfill（回灌：写入“权威知识层”）

写入位置选择规则（强制）：

- **项目级长期规则/流程** → `.serena/memories/`（短、硬、可执行）
- **策略/设计/规范（可读、可引用）** → `docs/`
- **feed 原文缓存（证据层）** → `.vibe/knowledge/`（默认 gitignore，不做权威）

冲突处理规则（强制）：

- 发现旧结论不再适用：**更新原位置**，并在“变更记录”写清楚原因（不要新增一份平行文档）。
- 发现“条件不同导致看似冲突”：拆成“适用边界”两条规则，避免含糊。

### 2.4 Memory（写入“套路/决策记忆”到 In-Memoria）

把“人脑会记住的东西”写进 `in_memoria`（而不是堆在文档里）：

- 决策：为什么选 A 不选 B
- 套路：遇到 X 问题，固定按 Y 步走
- 坑点：某类错误/卡住/反直觉行为的稳定复现与规避

建议字段（结构化，便于检索/路由）：

- `context`：触发场景
- `decision`：采取的做法
- `rationale`：理由/权衡
- `tradeoffs`：代价/副作用
- `evidence`：`S-xxx`/URL/文件
- `commands`：关键命令
- `files`：关键文件
- `confidence`：0~1

### 2.5 Index（索引同步：让检索层跟上）

当“权威知识层”更新后，默认同步检索加速器：

- 索引 `project_docs`：`python -X utf8 scripts/tools/vbrain.py ingest-docs -- --rebuild`（首次/大改）或 `python -X utf8 scripts/tools/vbrain.py ingest-docs`（增量）
- 索引 feed（可选）：`python -X utf8 scripts/tools/vbrain.py ingest-sources -- --only-new`

统一入口（推荐，用于降低摩擦）：

- `python -X utf8 scripts/tools/vbrain.py preheat --rebuild-docs`

---

## 3) 最小心智模型（像人脑一样）

- `local_rag` 像“阅读过的大量原文记忆碎片”，用于随时回忆证据。
- `docs/.serena` 像“你写下的定理/原则/方法”，少而精，长期有效。
- `in_memoria` 像“习惯与肌肉记忆”，让你下次一上来就知道改哪里、怎么做更稳。

核心原则：**原文只用来做证据召回；真正的进化来自“提炼 + 回灌 + 记忆套路化”。**
